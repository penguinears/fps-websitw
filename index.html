<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>FPS Test</title>

<style>
:root {
  --bg:#fff;
  --fg:#000;
  --panel:#eee;
  --grid:#ccc;
  --line:#0077cc;
}
body.dark {
  --bg:#111;
  --fg:#fff;
  --panel:#222;
  --grid:#444;
  --line:#4da3ff;
}

html,body {
  margin:0;
  overflow:hidden;
  background:var(--bg);
  color:var(--fg);
  font-family:sans-serif;
}

#top {
  position:fixed;
  top:0; left:0; right:0;
  background:var(--panel);
  padding:8px;
  z-index:10;
}

#graph {
  background:var(--bg);
  border:1px solid var(--grid);
  margin-top:6px;
}

#scene { display:block; }

#credit {
  position:fixed;
  bottom:8px;
  right:10px;
  font-size:12px;
  opacity:.7;
}
#credit a { color:var(--fg); text-decoration:none; }
</style>
</head>

<body class="dark">

<div id="top">
  <span id="fps">FPS:0</span> |
  <span id="low">1% Low:0</span> |
  <span id="count">Balls:0</span><br><br>

  <input id="ballInput" type="number" value="100">
  <button onclick="addBalls()">Add</button>
  <button onclick="clearBalls()">Clear</button>
  <button onclick="toggleTheme()">Dark / Light</button>

  <canvas id="graph" width="240" height="120"></canvas>
</div>

<canvas id="scene"></canvas>

<div id="credit">
  <a href="https://madebyleo.vercel.app" target="_blank">madebyleo.vercel.app</a>
</div>

<script>
const canvas = document.getElementById("scene");
const ctx = canvas.getContext("2d");
const graph = document.getElementById("graph");
const gctx = graph.getContext("2d");

const fpsEl = document.getElementById("fps");
const lowEl = document.getElementById("low");
const countEl = document.getElementById("count");
const input = document.getElementById("ballInput");

let balls = [];
let fpsHistory = [];
let frames = 0;
let last = performance.now();

function resize(){
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
resize();
addEventListener("resize",resize);

function newBall(){
  return {
    x:Math.random()*canvas.width,
    y:Math.random()*canvas.height,
    vx:(Math.random()-.5)*3,
    vy:(Math.random()-.5)*3,
    r:4,
    c:`hsl(${Math.random()*360},70%,60%)`
  };
}

function addBalls(){
  const n = parseInt(input.value) || 0;
  for(let i=0;i<n;i++) balls.push(newBall());
  countEl.textContent="Balls:"+balls.length;
}

function clearBalls(){
  balls=[];
  countEl.textContent="Balls:0";
}

function fpsLow(){
  if(fpsHistory.length<30) return 0;
  const s=[...fpsHistory].sort((a,b)=>a-b);
  return s[Math.floor(s.length*0.01)];
}

function drawGraph(){
  gctx.clearRect(0,0,240,120);

  gctx.strokeStyle=getComputedStyle(document.body).getPropertyValue("--grid");
  for(let i=0;i<=4;i++){
    let y=i/4*120;
    gctx.beginPath();
    gctx.moveTo(0,y);
    gctx.lineTo(240,y);
    gctx.stroke();
  }

  if(fpsHistory.length<2) return;
  gctx.strokeStyle=getComputedStyle(document.body).getPropertyValue("--line");
  gctx.beginPath();

  const step=240/(fpsHistory.length-1);
  fpsHistory.forEach((v,i)=>{
    let x=i*step;
    let y=120-(Math.min(v,120)/120)*120;
    i?gctx.lineTo(x,y):gctx.moveTo(x,y);
  });
  gctx.stroke();
}

function loop(t){
  frames++;
  if(t-last>=1000){
    fpsHistory.push(frames);
    if(fpsHistory.length>240) fpsHistory.shift();
    fpsEl.textContent="FPS:"+frames;
    lowEl.textContent="1% Low:"+fpsLow();
    frames=0;
    last=t;
  }

  ctx.clearRect(0,0,canvas.width,canvas.height);
  balls.forEach(b=>{
    b.x+=b.vx; b.y+=b.vy;
    if(b.x<b.r||b.x>canvas.width-b.r) b.vx*=-1;
    if(b.y<b.r||b.y>canvas.height-b.r) b.vy*=-1;
    ctx.beginPath();
    ctx.arc(b.x,b.y,b.r,0,Math.PI*2);
    ctx.fillStyle=b.c;
    ctx.fill();
  });

  drawGraph();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

function toggleTheme(){
  document.body.classList.toggle("dark");
}
</script>
</body>
</html>
