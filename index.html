<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FPS Ball Stress Test</title>

<style>
:root {
    --bg: #ffffff;
    --fg: #000000;
    --panel: #eeeeee;
    --grid: #cccccc;
    --graph-line: #0077cc;
}

body.dark {
    --bg: #111111;
    --fg: #ffffff;
    --panel: #222222;
    --grid: #444444;
    --graph-line: #4da3ff;
}

html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: var(--bg);
    color: var(--fg);
    font-family: sans-serif;
}

#top {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: var(--panel);
    padding: 10px;
    z-index: 10;
}

#content {
    position: relative;
}

canvas {
    display: block;
}

#graph {
    border: 1px solid var(--grid);
    background: var(--bg);
    margin-top: 6px;
}

button, input {
    margin-right: 6px;
}

#showBtn {
    position: fixed;
    top: 10px;
    left: 10px;
    display: none;
    z-index: 20;
}

#credit {
    position: fixed;
    bottom: 8px;
    right: 10px;
    font-size: 12px;
    opacity: 0.7;
}

#credit a {
    color: var(--fg);
    text-decoration: none;
}
</style>
</head>

<body class="dark">

<div id="top">
    <span id="fps">FPS: 0</span> |
    <span id="low">1% Low: 0</span> |
    <span id="count">Balls: 0</span> |
    Best: <span id="bestScore">0</span>
    <br><br>

    <input id="ballInput" type="number" value="100">
    <button onclick="addFromInput()">Add</button>
    <button onclick="deleteAll()">Clear</button>
    <button onclick="startTest()">Start Test</button>
    <button onclick="stopTest()">Stop</button>
    <button onclick="toggleTheme()">Dark / Light</button>
    <button onclick="hidePanel()">Hide Panel</button>

    <canvas id="graph"></canvas>
</div>

<button id="showBtn" onclick="showPanel()">Show Panel</button>

<div id="content">
    <canvas id="scene"></canvas>
</div>

<div id="credit">
    <a href="https://madebyleo.vercel.app" target="_blank">madebyleo.vercel.app</a>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

/* =======================
   Canvas setup
======================= */
const canvas = document.getElementById("scene");
const ctx = canvas.getContext("2d");

const graph = document.getElementById("graph");
const gctx = graph.getContext("2d");

function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
function resizeGraph() {
    graph.width = 240;
    graph.height = 120;
}
resizeCanvas();
resizeGraph();

window.addEventListener("resize", () => {
    resizeCanvas();
    resizeGraph();
    adjustContentOffset();
});

/* =======================
   UI
======================= */
const fpsEl = document.getElementById("fps");
const lowEl = document.getElementById("low");
const countEl = document.getElementById("count");
const bestScoreEl = document.getElementById("bestScore");
const topPanel = document.getElementById("top");
const content = document.getElementById("content");
const showBtn = document.getElementById("showBtn");

/* =======================
   Layout fix
======================= */
function adjustContentOffset() {
    content.style.marginTop = (topPanel.offsetHeight + 10) + "px";
}
adjustContentOffset();

/* =======================
   State
======================= */
let balls = [];
let running = false;
let spawnTimer = null;

/* =======================
   Leaderboard
======================= */
let bestScore = Number(localStorage.getItem("bestScore")) || 0;
bestScoreEl.textContent = bestScore;

/* =======================
   FPS tracking
======================= */
let lastSecond = performance.now();
let frameCounter = 0;
let fpsHistory = [];
let currentFPS = 0;

/* =======================
   Ball factory
======================= */
function createBall() {
    return {
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        vx: (Math.random() - 0.5) * 3,
        vy: (Math.random() - 0.5) * 3,
        r: 4,
        c: `hsl(${Math.random() * 360},70%,60%)`
    };
}

/* =======================
   Ball management
======================= */
function updateBallCount() {
    countEl.textContent = "Balls: " + balls.length;
    if (balls.length > bestScore) {
        bestScore = balls.length;
        bestScoreEl.textContent = bestScore;
        localStorage.setItem("bestScore", bestScore);
    }
}

window.addFromInput = function () {
    const n = parseInt(ballInput.value);
    if (n > 0) {
        for (let i = 0; i < n; i++) balls.push(createBall());
        updateBallCount();
    }
};

window.deleteAll = function () {
    balls.length = 0;
    updateBallCount();
};

/* =======================
   Test controls
======================= */
window.startTest = function () {
    if (running) return;
    running = true;
    spawnTimer = setInterval(() => {
        for (let i = 0; i < 25; i++) balls.push(createBall());
        updateBallCount();
    }, 400);
};

window.stopTest = function () {
    running = false;
    clearInterval(spawnTimer);
};

/* =======================
   FPS + 1% low
======================= */
function calculate1PercentLow() {
    if (fpsHistory.length < 30) return 0;
    const sorted = [...fpsHistory].sort((a, b) => a - b);
    return sorted[Math.floor(sorted.length * 0.01)] || 0;
}

function updateFPS(time) {
    frameCounter++;
    if (time - lastSecond >= 1000) {
        currentFPS = frameCounter;
        frameCounter = 0;
        lastSecond = time;

        fpsHistory.push(currentFPS);
        if (fpsHistory.length > 240) fpsHistory.shift();

        fpsEl.textContent = "FPS: " + currentFPS;
        lowEl.textContent = "1% Low: " + calculate1PercentLow();
    }
}

/* =======================
   Graph (FIXED)
======================= */
function drawGraph() {
    gctx.clearRect(0, 0, graph.width, graph.height);

    gctx.strokeStyle = getComputedStyle(document.body)
        .getPropertyValue("--grid");

    for (let i = 0; i <= 4; i++) {
        const y = (i / 4) * graph.height;
        gctx.beginPath();
