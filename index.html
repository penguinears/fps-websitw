<script>
document.addEventListener("DOMContentLoaded", () => {

/* =======================
   Canvas setup
======================= */
const canvas = document.getElementById("scene");
const ctx = canvas.getContext("2d");

const graph = document.getElementById("graph");
const gctx = graph.getContext("2d");

function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
resizeCanvas();

function resizeGraph() {
    graph.width = 240;
    graph.height = 120;
}
resizeGraph();

window.addEventListener("resize", () => {
    resizeCanvas();
    resizeGraph();
});

/* =======================
   UI elements
======================= */
const fpsEl = document.getElementById("fps");
const lowEl = document.getElementById("low");
const countEl = document.getElementById("count");
const bestScoreEl = document.getElementById("bestScore");
const topPanel = document.getElementById("top");
const content = document.getElementById("content");
const showBtn = document.getElementById("showBtn");

/* =======================
   Layout fix (no overlap)
======================= */
function adjustContentOffset() {
    if (!topPanel || !content) return;
    content.style.marginTop = (topPanel.offsetHeight + 20) + "px";
}
adjustContentOffset();
window.addEventListener("resize", adjustContentOffset);

/* =======================
   State
======================= */
let balls = [];
let running = false;
let spawnTimer = null;

/* =======================
   Leaderboard (local)
======================= */
let bestScore = Number(localStorage.getItem("bestScore")) || 0;
bestScoreEl.textContent = bestScore;

/* =======================
   FPS tracking
======================= */
let lastSecond = performance.now();
let frameCounter = 0;
let fpsHistory = [];
let currentFPS = 0;

/* =======================
   Ball factory
======================= */
function createBall() {
    return {
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        vx: (Math.random() - 0.5) * 3,
        vy: (Math.random() - 0.5) * 3,
        r: 4,
        c: `hsl(${Math.random() * 360},70%,60%)`
    };
}

/* =======================
   Ball management
======================= */
function updateBallCount() {
    countEl.textContent = "Balls: " + balls.length;

    if (balls.length > bestScore) {
        bestScore = balls.length;
        bestScoreEl.textContent = bestScore;
        localStorage.setItem("bestScore", bestScore);
    }
}

function addBalls(n) {
    for (let i = 0; i < n; i++) balls.push(createBall());
    updateBallCount();
}

window.addFromInput = function () {
    const n = parseInt(document.getElementById("ballInput").value);
    if (n > 0) addBalls(n);
};

window.deleteAll = function () {
    balls.length = 0;
    updateBallCount();
};

/* =======================
   Test controls
======================= */
window.startTest = function () {
    if (running) return;
    running = true;
    spawnTimer = setInterval(() => addBalls(25), 400);
};

window.stopTest = function () {
    running = false;
    clearInterval(spawnTimer);
};

/* =======================
   FPS + 1% low
======================= */
function calculate1PercentLow() {
    if (fpsHistory.length < 30) return 0;
    const sorted = [...fpsHistory].sort((a, b) => a - b);
    return sorted[Math.floor(sorted.length * 0.01)] || 0;
}

function updateFPS(time) {
    frameCounter++;

    if (time - lastSecond >= 1000) {
        currentFPS = frameCounter;
        frameCounter = 0;
        lastSecond = time;

        fpsHistory.push(currentFPS);
        if (fpsHistory.length > 240) fpsHistory.shift();

        fpsEl.textContent = "FPS: " + currentFPS;
        lowEl.textContent = "1% Low: " + calculate1PercentLow();
    }
}

/* =======================
   Graph
======================= */
function drawGraph() {
    gctx.clearRect(0, 0, graph.width, graph.height);

    gctx.strokeStyle = "#ddd";
    for (let i = 0; i <= 4; i++) {
        const y = (i / 4) * graph.height;
        gctx.beginPath();
        gctx.moveTo(0, y);
        gctx.lineTo(graph.width, y);
        gctx.stroke();
    }

    gctx.beginPath();
    gctx.strokeStyle = "#0077cc";

    fpsHistory.forEach((v, i) => {
        const x = i;
        const y = graph.height - (Math.min(v, 120) / 120) * graph.height;
        if (i === 0) gctx.moveTo(x, y);
        else gctx.lineTo(x, y);
    });

    gctx.stroke();
}

/* =======================
   Simulation
======================= */
function updateBalls() {
    for (const b of balls) {
        b.x += b.vx;
        b.y += b.vy;

        if (b.x < b.r || b.x > canvas.width - b.r) b.vx *= -1;
        if (b.y < b.r || b.y > canvas.height - b.r) b.vy *= -1;
    }
}

function drawBalls() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    for (const b of balls) {
        ctx.beginPath();
        ctx.arc(b.x, b.y, b.r, 0, Math.PI * 2);
        ctx.fillStyle = b.c;
        ctx.fill();
    }
}

/* =======================
   Panel hide / show
======================= */
window.hidePanel = function () {
    topPanel.style.display = "none";
    showBtn.style.display = "block";
};

window.showPanel = function () {
    topPanel.style.display = "block";
    showBtn.style.display = "none";
    adjustContentOffset();
};

/* =======================
   Main loop
======================= */
function loop(time) {
    updateFPS(time);
    updateBalls();
    drawBalls();
    drawGraph();
    requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

});
</script>
